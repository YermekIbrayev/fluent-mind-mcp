# Tasks: User Story 6 (T058-T068)

[← Back to Tasks Index](../tasks.md)

**Purpose**: Advanced features - dynamic catalog refresh from Flowise server

**⚠️ File Size Rule**: Goal ≤100 lines, yellow 101-150, HARD LIMIT 200 lines (validated by T102)

---

## Phase 8: User Story 6 - Dynamic Node Catalog (Priority: P2)

**Goal**: Node catalog refreshes from Flowise server before flow creation (>24h staleness)

**Independent Test**: Force refresh, verify new nodes added, check fallback to cached data if Flowise down

**Contract**: refresh_node_catalog (contracts/refresh_node_catalog.json)

### Implementation (T058-T066)

- [ ] T058 [US6] Implement NodeCatalogService.refresh in src/fluent_mind_mcp/services/node_catalog_service.py
  - Method: refresh(force: bool = False) -> RefreshResult
  - Check staleness unless force=True
  - Fetch node list from Flowise API /api/v1/nodes-list
  - Compare with vector DB cache
  - Return RefreshResult: nodes_added, nodes_updated, nodes_removed, status

- [ ] T059 [US6] Implement staleness check (>24h threshold) in NodeCatalogService
  - Method: _is_stale() -> bool
  - Read last_refresh_timestamp from CacheMetadata in vector DB
  - Calculate age: now - last_refresh_timestamp
  - Return True if age > 24 hours
  - Configurable threshold via STALENESS_THRESHOLD_HOURS env var

- [ ] T060 [US6] Implement Flowise API /api/v1/nodes-list integration in NodeCatalogService
  - Method: _fetch_nodes_from_flowise() -> list[NodeMetadata]
  - Call FlowiseApiClient.get_nodes_list()
  - Parse response: name, label, version, category, base_classes, description, deprecated
  - Return list of NodeMetadata objects
  - Handle API errors with circuit breaker

- [ ] T061 [US6] Implement change detection (new, updated, removed, deprecated) in NodeCatalogService
  - Method: _detect_changes(current_nodes: list[NodeMetadata], cached_nodes: list[NodeMetadata]) -> ChangeSet
  - Compare node_name, version, description, deprecated status
  - Return ChangeSet: nodes_to_add, nodes_to_update, nodes_to_remove, nodes_to_deprecate
  - Log summary: "Detected X new, Y updated, Z removed nodes"

- [ ] T062 [US6] Implement incremental updates (<30% changes) vs. full rebuild logic
  - Method: _apply_changes(change_set: ChangeSet) -> RefreshResult
  - Calculate change percentage: (added + updated + removed) / total_nodes
  - If <30% changes: incremental update (add/update/remove individual nodes)
  - If ≥30% changes: full rebuild (clear collection, re-add all nodes)
  - Update CacheMetadata with new timestamp and node count

- [ ] T063 [US6] Implement fallback to cached vector DB with staleness warning (<50 tokens)
  - If Flowise API unreachable during refresh, catch CircuitOpenError
  - Log warning: "Node catalog refresh failed. Using cached data (stale: Xh)."
  - Return RefreshResult with status="fallback_to_cache" and staleness info
  - Allow build_flow to proceed with cached nodes
  - Token budget: 50 tokens for warning message

- [ ] T064 [US6] Integrate staleness check before build_flow execution in BuildFlowService
  - In build_from_template and build_from_nodes, call NodeCatalogService._is_stale()
  - If stale, call NodeCatalogService.refresh() automatically
  - Log: "Node catalog stale. Refreshing before flow creation."
  - Proceed with build_flow after refresh completes (or fallback)

- [ ] T065 [US6] Add deprecated node filtering/ranking in VectorSearchService
  - When searching nodes, filter out deprecated nodes by default
  - Add optional parameter: include_deprecated (default False)
  - If deprecated nodes in results, rank lower and add deprecation warning
  - Warning format: "{node_name} (deprecated - use {alternative} instead)"

- [ ] T066 [US6] Add refresh_node_catalog MCP tool in src/fluent_mind_mcp/server.py
  - Tool definition with parameter: force (bool, default False)
  - Call NodeCatalogService.refresh(force)
  - Return RefreshResult: nodes_added, nodes_updated, nodes_removed, status, timestamp
  - Allow AI to manually trigger refresh if needed

### Testing & Validation (T067-T068)

- [ ] T067 [US6] Create manual test checklist in tests/checklists/user_story_6_checklist.md
  - Scenario 1: build_flow invoked → system checks staleness (>24h), queries Flowise API, proceeds
  - Scenario 2: Flowise API returns node list → version, baseClass, category, deprecated status extracted
  - Scenario 3: Fetched nodes compared with cache → new/updated/removed nodes detected correctly
  - Scenario 4: Deprecated node in Flowise → excluded from search or ranked lower with warning
  - Scenario 5: Multiple versions of node → latest non-deprecated version returned
  - Scenario 6: Refresh completes → timestamp and version metadata recorded
  - Scenario 7: Flowise unreachable → fallback to cached DB with staleness warning (<50 tokens)
  - Scenario 8: No changes since last refresh → refresh skips DB update, logs "no changes" (<30 tokens)

- [ ] T068 [US6] Validate acceptance scenarios 1-8 pass via manual checklist
  - Execute all 8 scenarios manually
  - Simulate Flowise down for scenario 7
  - Document results in checklist
  - Mark as PASS or FAIL with notes

**Checkpoint**: User Story 6 complete - dynamic catalog refresh functional

---

[← Back to Tasks Index](../tasks.md) | [Next: User Story 7 →](04b-us7.md)
