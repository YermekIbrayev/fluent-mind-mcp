# Tasks: User Story 3 (T032-T053)

[‚Üê Back to Tasks Index](../tasks.md)

**Purpose**: Core MVP - minimal build_flow function for chatflow creation

**‚ö†Ô∏è File Size Rule**: Goal ‚â§100 lines, yellow 101-150, HARD LIMIT 200 lines (validated by T102)

**TDD Rule**: Every implementation task MUST have a test task BEFORE it. Tests must FAIL first (Red), then implementation makes them pass (Green).

---

## Phase 5: User Story 3 - build_flow Function (Priority: P1) üéØ

**Goal**: AI invokes build_flow with minimal arguments (<20 tokens) to create chatflows

**Independent Test**: Call build_flow(template_id="tmpl_123") creates chatflow using <30 tokens response

**Contract**: build_flow (contracts/build_flow.json)

### TDD: Write Tests FIRST (T032-T034)

**NOTE**: These tests MUST be written first and MUST FAIL before implementation begins.

- [ ] T032 [P] [US3] [TDD-RED] Create tests/unit/phase1/test_build_flow_service.py (18 tests for BuildFlowService)
  - **Purpose**: Define BuildFlowService API contract (Red phase)
  - **Tests**:
    - test_build_from_template_basic: Build from valid template_id returns BuildFlowResponse
    - test_build_from_template_with_parameters: Custom parameters (model, temperature) substituted
    - test_build_from_template_invalid_id: Invalid template_id raises TemplateNotFoundError
    - test_build_from_nodes_basic: Build from node list with auto connections
    - test_build_from_nodes_invalid_name: Invalid node name raises ValidationError
    - test_build_from_nodes_empty_list: Empty nodes list raises ValidationError
    - test_template_retrieval: _retrieve_template loads full flowData
    - test_parameter_substitution: _substitute_parameters replaces {{model}}, {{temperature}}
    - test_parameter_validation: Invalid parameter type raises ValidationError
    - test_connection_inference_simple: 2-3 nodes connected correctly (Input‚ÜíProcessing‚ÜíOutput)
    - test_connection_inference_complex: 5+ nodes with memory and tools connected
    - test_connection_inference_validation: Missing required inputs raises ConnectionInferenceError
    - test_node_positioning_linear: 3 nodes positioned left-to-right (x=0,300,600)
    - test_node_positioning_multi_row: 6+ nodes use multiple rows
    - test_flowdata_validation: _validate_flowData catches missing nodes/edges/invalid refs
    - test_compact_response_format: BuildFlowResponse <30 tokens (chatflow_id, name, status)
    - test_error_response_format: Error responses <50 tokens with recovery guidance
    - test_performance_template: Build from template <10s (per NFR-004)
  - **Validation**: pytest tests/unit/phase1/test_build_flow_service.py -v ‚Üí All 18 SKIP
  - **DO NOT IMPLEMENT** BuildFlowService yet - tests must fail first

- [ ] T033 [P] [US3] [TDD-RED] Create tests/unit/phase1/test_connection_inference.py (12 tests for connection algorithm)
  - **Purpose**: Comprehensive testing of connection inference logic
  - **Tests**:
    - test_categorize_nodes_input: Document loaders categorized as Input
    - test_categorize_nodes_processing: Chat models, LLMs categorized as Processing
    - test_categorize_nodes_memory: Memory nodes categorized correctly
    - test_categorize_nodes_tools: Tools categorized correctly
    - test_categorize_nodes_output: Chains, agents categorized as Output
    - test_topological_ordering: Nodes sorted Input‚ÜíTools‚ÜíProcessing‚ÜíMemory‚ÜíOutput
    - test_type_compatible_chaining: BaseClass matching (output‚Üíinput compatibility)
    - test_required_inputs_validation: All required inputs satisfied
    - test_edge_generation: Correct source/target node IDs and handles
    - test_circular_dependency_detection: Detect and reject circular connections
    - test_disconnected_nodes_detection: Warn about nodes with no connections
    - test_complex_flow_inference: Multi-branch flows (e.g., RAG with multiple retrievers)
  - **Validation**: pytest tests/unit/phase1/test_connection_inference.py -v ‚Üí All 12 SKIP

- [ ] T034 [P] [US3] [TDD-RED] Create tests/integration/phase1/test_us3_build_journey.py (5 end-to-end scenarios)
  - **Purpose**: Validate complete US3 acceptance scenarios
  - **Tests**:
    - test_build_from_template_simple: build_flow(template_id="tmpl_simple_chat") ‚Üí chatflow created, <20 token invocation
    - test_build_from_nodes_auto_connect: build_flow(nodes=["chatOpenAI", "bufferMemory"], connections="auto") ‚Üí chatflow with automatic connections, <50 tokens
    - test_build_with_parameters: build_flow(template_id="tmpl_chat", model="gpt-4", temperature=0.7) ‚Üí parameters applied
    - test_compact_response: Response contains only chatflow_id, name, status (<30 tokens)
    - test_full_lifecycle: Template search ‚Üí build_flow ‚Üí verify chatflow in Flowise (<60s total)
  - **Validation**: pytest tests/integration/phase1/test_us3_build_journey.py -v ‚Üí All 5 SKIP
  - **DO NOT IMPLEMENT** BuildFlowService yet

### Implementation (T035-T049)

**NOTE**: Only start implementation AFTER tests T032-T034 are written and failing.

- [ ] T035 [US3] [TDD-GREEN] Implement BuildFlowService.build_from_template in src/fluent_mind_mcp/services/build_flow_service.py
  - **Pre-condition**: Run `pytest tests/unit/phase1/test_build_flow_service.py::test_build_from_template_* -v` ‚Üí All related tests FAIL or SKIP
  - Method: build_from_template(template_id: str, parameters: dict | None = None) -> BuildFlowResponse
  - Retrieve template from ChromaDB
  - Substitute parameters if provided
  - Generate flowData from template
  - **Post-condition**: test_build_from_template_basic, test_build_from_template_with_parameters ‚Üí PASS

- [ ] T036 [US3] [TDD-GREEN] Implement template retrieval and validation
  - Method: _retrieve_template(template_id: str) -> FlowTemplate
  - Validate template exists (raise TemplateNotFoundError if not)
  - Load full flowData from template
  - **Validation**: pytest test_build_flow_service::test_template_retrieval ‚Üí PASS
  - **Validation**: pytest test_build_flow_service::test_build_from_template_invalid_id ‚Üí PASS

- [ ] T037 [US3] [TDD-GREEN] Implement parameter substitution for templates
  - Method: _substitute_parameters(flowData: dict, parameters: dict) -> dict
  - Replace placeholder values ({{model}}, {{temperature}}, etc.)
  - Set chatflow name if provided
  - Validate parameter types
  - **Validation**: pytest test_build_flow_service::test_parameter_substitution ‚Üí PASS
  - **Validation**: pytest test_build_flow_service::test_parameter_validation ‚Üí PASS

- [ ] T038 [US3] [TDD-GREEN] Implement node categorization in connection inference
  - **Pre-condition**: Run `pytest tests/unit/phase1/test_connection_inference.py::test_categorize_* -v` ‚Üí All FAIL/SKIP
  - Method: _categorize_nodes(nodes: list[Node]) -> dict[str, list[Node]]
  - Categories: Input, Processing, Memory, Tools, Output
  - Use baseClass and category heuristics from T035 description
  - **Validation**: pytest test_connection_inference::test_categorize_* ‚Üí All 5 categorization tests PASS

- [ ] T039 [US3] [TDD-GREEN] Implement topological ordering for node categories
  - Method: _topological_sort(categorized_nodes: dict) -> list[Node]
  - Order: Input ‚Üí Tools ‚Üí Processing ‚Üí Memory ‚Üí Output
  - **Validation**: pytest test_connection_inference::test_topological_ordering ‚Üí PASS

- [ ] T040 [US3] [TDD-GREEN] Implement type-compatible chaining algorithm
  - Method: _match_base_classes(nodes: list[Node]) -> list[tuple[Node, Node]]
  - Match output baseClass to input baseClasses
  - Create node pairs for connection
  - **Validation**: pytest test_connection_inference::test_type_compatible_chaining ‚Üí PASS

- [ ] T041 [US3] [TDD-GREEN] Implement connection validation and edge generation
  - Method: _generate_edges(node_pairs: list[tuple]) -> list[Edge]
  - Validate all required inputs satisfied (raise ConnectionInferenceError if not)
  - Generate Edge objects with source/target/handles
  - Detect circular dependencies
  - **Validation**: pytest test_connection_inference::test_required_inputs_validation ‚Üí PASS
  - **Validation**: pytest test_connection_inference::test_edge_generation ‚Üí PASS
  - **Validation**: pytest test_connection_inference::test_circular_dependency_detection ‚Üí PASS

- [ ] T042 [US3] [TDD-GREEN] Implement complete connection inference algorithm
  - Method: _infer_connections(nodes: list[Node]) -> list[Edge]
  - Combine categorization, ordering, matching, validation
  - **Validation**: pytest test_connection_inference::test_connection_inference_simple ‚Üí PASS
  - **Validation**: pytest test_connection_inference::test_connection_inference_complex ‚Üí PASS

- [ ] T043 [US3] [TDD-GREEN] Implement node positioning algorithm (left-to-right flow)
  - Method: _calculate_positions(nodes: list[Node], edges: list[Edge]) -> dict[str, Position]
  - Calculate connection depth for each node
  - Assign columns by depth, rows by order
  - Position: x = column * 300px, y = row * 200px
  - **Validation**: pytest test_build_flow_service::test_node_positioning_linear ‚Üí PASS
  - **Validation**: pytest test_build_flow_service::test_node_positioning_multi_row ‚Üí PASS

- [ ] T044 [US3] [TDD-GREEN] Implement BuildFlowService.build_from_nodes for custom node lists
  - Method: build_from_nodes(nodes: list[str], connections: str = "auto", parameters: dict | None = None) -> BuildFlowResponse
  - Validate node names exist in vector DB
  - Create Node objects with default configuration
  - If connections="auto", call _infer_connections
  - Call _calculate_positions
  - Generate flowData structure
  - **Validation**: pytest test_build_flow_service::test_build_from_nodes_basic ‚Üí PASS
  - **Validation**: pytest test_build_flow_service::test_build_from_nodes_invalid_name ‚Üí PASS
  - **Validation**: pytest test_build_flow_service::test_build_from_nodes_empty_list ‚Üí PASS

- [ ] T045 [US3] [TDD-GREEN] Implement automatic connection generation (connections="auto")
  - Default connections parameter to "auto"
  - Apply connection inference algorithm (T042)
  - Validate all required inputs satisfied
  - **Validation**: pytest test_connection_inference tests all PASS (12 tests)

- [ ] T046 [US3] [TDD-GREEN] Add flowData validation before Flowise API submission
  - Method: _validate_flowData(flowData: dict) -> None
  - Check required fields: nodes, edges, chatflow name
  - Validate node IDs referenced in edges exist
  - Validate edge sourceHandle/targetHandle exist on nodes
  - Raise BuildFlowError with details if invalid
  - **Validation**: pytest test_build_flow_service::test_flowdata_validation ‚Üí PASS

- [ ] T047 [US3] [TDD-GREEN] Implement compact response format (<30 tokens)
  - BuildFlowResponse model: chatflow_id, name, status
  - Exclude flowData from response
  - Include error message if status="error" (<50 tokens)
  - **Validation**: pytest test_build_flow_service::test_compact_response_format ‚Üí PASS
  - **Validation**: pytest test_build_flow_service::test_error_response_format ‚Üí PASS

- [ ] T048 [US3] [TDD-GREEN] Add build_flow MCP tool in src/fluent_mind_mcp/server.py
  - Tool definition with parameters: template_id OR nodes (mutually exclusive), connections, parameters
  - oneOf validation: exactly one of template_id or nodes required
  - Call BuildFlowService.build_from_template or build_from_nodes
  - Return BuildFlowResponse or error
  - **Validation**: Manual MCP tool test via quickstart.md

- [ ] T049 [US3] [TDD-REFACTOR] Optimize and refactor while keeping all tests green
  - **Validation**: pytest tests/unit/phase1/test_build_flow_service.py -v ‚Üí All 18 PASS
  - **Validation**: pytest tests/unit/phase1/test_connection_inference.py -v ‚Üí All 12 PASS
  - **Validation**: pytest tests/integration/phase1/test_us3_build_journey.py -v ‚Üí All 5 PASS
  - Run performance profiling to ensure <10s for templates, <15s for custom nodes

**Checkpoint**: User Story 3 complete - all 35 tests passing (18 + 12 + 5)

---

## Summary

**Total Tasks**: 22 (was 12, added 10 TDD-focused tasks)
- TDD Test Tasks: 3 (T032-T034)
- Implementation Tasks: 19 (T035-T049, with TDD-GREEN workflow)

**Test Coverage**:
- BuildFlowService: 18 unit tests
- Connection Inference: 12 unit tests
- End-to-end: 5 integration tests
- **Total**: 35 automated tests for US3

**TDD Workflow**:
1. Write tests FIRST (T032-T034)
2. Verify all 35 tests FAIL or SKIP (Red phase)
3. Implement incrementally (T035-T048), each task turns specific tests green
4. Refactor (T049) while keeping all 35 tests green

**Validation Checkpoints**:
- After T034: 35 tests created, all SKIP/FAIL
- After T035-T037: Template building tests PASS (~6 tests)
- After T038-T042: Connection inference tests PASS (~12 tests)
- After T043-T047: Remaining build_flow tests PASS (~12 tests)
- After T049: All 35 tests PASS

**Key Algorithms Tested**:
- Connection inference (12 dedicated tests)
- Node positioning (2 tests)
- Parameter substitution (2 tests)
- FlowData validation (1 test)

---

[‚Üê Back to Tasks Index](../tasks.md) | [Next: User Stories 4-5 ‚Üí](03-us4-us5.md)
