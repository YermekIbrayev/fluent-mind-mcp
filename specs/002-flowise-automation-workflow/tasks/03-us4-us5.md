# Tasks: User Stories 4-5 (T044-T057)

[← Back to Tasks Index](../tasks.md)

**Purpose**: Vector DB setup and error handling support

**⚠️ File Size Rule**: Goal ≤100 lines, yellow 101-150, HARD LIMIT 200 lines (validated by T102)

---

## Phase 6: User Story 4 - Vector DB Setup (Priority: P2)

**Goal**: Vector DB populated with node descriptions and templates for semantic search

**Independent Test**: Query DB with "memory" returns BufferMemory, BufferWindowMemory, ConversationMemory

### Implementation (T044-T048)

- [ ] T044 [US4] Create node description extraction script from Flowise node definitions
  - Script: src/fluent_mind_mcp/scripts/extract_node_descriptions.py
  - Parse Flowise node metadata (from /api/v1/nodes-list or local docs)
  - Extract: node_name, label, category, base_classes, description, use_cases
  - Generate structured NodeDescription objects
  - Output to JSON file for review

- [ ] T045 [US4] Generate embeddings for all 87 nodes using EmbeddingClient
  - For each NodeDescription, combine label + description + use_cases
  - Call EmbeddingClient.generate_embedding(text) → 384-dim vector
  - Batch process for efficiency (10-20 nodes per batch)
  - Performance target: <5s total for 87 nodes

- [ ] T046 [US4] Store node descriptions with embeddings in ChromaDB nodes collection
  - Add documents to nodes collection: id=node_name, embedding=vector, metadata={label, category, base_classes, deprecated}
  - Include full description text for retrieval
  - Verify storage with health check query

- [ ] T047 [US4] Implement incremental update logic (update existing, add new) in VectorDatabaseClient
  - Method: update_or_add_document(collection_name: str, doc_id: str, text: str, metadata: dict) -> None
  - Check if document exists by ID
  - If exists: update embedding and metadata
  - If not exists: add new document
  - Log update operation (node added/updated)

- [ ] T048 [US4] Verify vector search returns relevant nodes ranked by similarity
  - Test query: "memory" → expect BufferMemory, BufferWindowMemory, ConversationMemory in top 5
  - Test query: "chat model" → expect ChatOpenAI, ChatAnthropic in top 5
  - Test query: "embeddings" → expect OpenAIEmbeddings, HuggingFaceEmbeddings
  - Verify relevance_score > 0.7 for all results

### Testing & Validation (T049-T050)

- [ ] T049 [US4] Create manual test checklist in tests/checklists/user_story_4_checklist.md
  - Scenario 1: Process Flowise node definitions → vector embeddings created
  - Scenario 2: Manually curated templates stored with rich descriptions and flowData
  - Scenario 3: Update node description → existing embedding refreshed without full rebuild
  - Scenario 4: Query "memory" → relevant nodes returned ranked by relevance

- [ ] T050 [US4] Validate acceptance scenarios 1-4 pass via manual checklist
  - Execute all 4 scenarios manually
  - Document results in checklist
  - Mark as PASS or FAIL with notes

**Checkpoint**: User Story 4 complete - vector DB populated and searchable

---

## Phase 7: User Story 5 - Error Handling (Priority: P3)

**Goal**: Compact error messages (<50 tokens) maintain token efficiency in error scenarios

**Independent Test**: Trigger errors (no results, invalid template, missing param) and verify <50 token messages

### Implementation (T051-T055)

- [ ] T051 [US5] Implement NO_RESULTS error with query refinement suggestion (<30 tokens)
  - Error code: NO_RESULTS
  - Message template: "No nodes match. Try broader terms. (e.g., 'chat' instead of 'chatbot with memory and RAG')"
  - Token budget: 30 tokens
  - Return from VectorSearchService when search returns empty list

- [ ] T052 [US5] Implement INVALID_TEMPLATE error with search templates suggestion (<40 tokens)
  - Error code: INVALID_TEMPLATE
  - Message template: "Template '{template_id}' not found. Use search_templates to find available templates."
  - Token budget: 40 tokens
  - Raise from BuildFlowService when template_id not in vector DB

- [ ] T053 [US5] Implement MISSING_PARAMETER error with required parameter indication (<50 tokens)
  - Error code: MISSING_PARAMETER
  - Message template: "Missing required parameter: '{param_name}'. Example: {example_value}"
  - Token budget: 50 tokens
  - Raise from BuildFlowService when required parameter not provided

- [ ] T054 [US5] Implement BUILD_FLOW_FAILURE error with recovery suggestion (<50 tokens)
  - Error code: BUILD_FLOW_FAILURE
  - Message template: "Chatflow creation failed: {reason}. {recovery_suggestion}"
  - Examples:
    - "Cannot connect nodes. Check compatibility." (connection inference failure)
    - "Flowise API error. Retry in 5s." (API failure)
  - Token budget: 50 tokens
  - Raise from BuildFlowService on flowData validation or API errors

- [ ] T055 [US5] Add error response formatting to all MCP tools
  - Update search_nodes, search_templates, build_flow tools in server.py
  - Wrap service calls in try-except blocks
  - Catch custom exceptions (VectorSearchError, TemplateNotFoundError, BuildFlowError, etc.)
  - Return error response: {"status": "error", "error_code": "...", "message": "..."}
  - Ensure all error messages within token budgets

### Testing & Validation (T056-T057)

- [ ] T056 [US5] Create manual test checklist in tests/checklists/user_story_5_checklist.md
  - Scenario 1: Vector search with no matches → message suggests query refinement using <30 tokens
  - Scenario 2: Invalid template_id → error indicates template not found and suggests searching templates using <40 tokens
  - Scenario 3: Missing required parameter → error specifies which parameter needed using <50 tokens
  - Scenario 4: build_flow failure → response includes error type and recovery suggestion using <50 tokens

- [ ] T057 [US5] Validate acceptance scenarios 1-4 pass via manual checklist
  - Execute all 4 scenarios manually
  - Count tokens in each error message
  - Document results in checklist
  - Mark as PASS or FAIL with token counts

**Checkpoint**: User Story 5 complete - error handling token-efficient

---

[← Back to Tasks Index](../tasks.md) | [Next: User Stories 6-7 →](04-us6-us7.md)
