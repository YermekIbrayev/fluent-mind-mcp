# Tasks: User Story 7 (T069-T082)

[‚Üê Back to Tasks Index](../tasks.md)

**Purpose**: Advanced features - spec-driven workflow for complex chatflows

**‚ö†Ô∏è File Size Rule**: Goal ‚â§100 lines, yellow 101-150, HARD LIMIT 200 lines (validated by T102)

---

## Phase 9: User Story 7 - Spec-Driven Workflow (Priority: P1) üéØ

**Goal**: Complex chatflows trigger spec-driven workflow with human validation before creation

**Independent Test**: Request "multi-agent system with 5 tools" generates spec, asks questions, presents design for approval

### Implementation (T069-T080)

- [ ] T069 [US7] Implement SpecDrivenWorkflowService.analyze_complexity in src/fluent_mind_mcp/services/workflow_service.py
  - Method: analyze_complexity(user_request: str) -> ComplexityAnalysis
  - Check criteria: >5 nodes, keywords (agent, multi-step, conditional, routing), template confidence <70%, multiple integrations
  - Return ComplexityAnalysis: is_complex (bool), reasons (list[str]), recommended_workflow ("simple" or "spec_driven")
  - Log decision: "Request complexity: {reasons} ‚Üí {workflow}"

- [ ] T070 [US7] Implement complexity detection (>5 nodes, keywords, template confidence <70%)
  - Parse user request for node count estimation
  - Detect keywords: "agent", "multi-step", "conditional", "routing", "decision", "complex", "advanced", "custom"
  - Search templates with user request, check if best match confidence <70%
  - Check for multiple integration mentions (e.g., "Slack + Google Calendar + database")
  - Return True if any criterion met

- [ ] T071 [US7] Implement spec generation via .specify/commands/speckit.specify integration
  - Method: _generate_spec(user_request: str, feature_dir: str) -> ChatflowSpecification
  - Create feature directory: specs/{feature_name}/
  - Write initial user input to feature_dir/user_input.txt
  - Run subprocess: .specify/commands/speckit.specify (via SlashCommand tool if available, or direct subprocess)
  - Parse generated spec.md ‚Üí ChatflowSpecification model
  - Return specification for next phase

- [ ] T072 [US7] Implement clarification questions (max 5) via speckit.clarify integration
  - Method: _clarify_spec(feature_dir: str) -> list[ClarificationQuestion]
  - Run subprocess: .specify/commands/speckit.clarify
  - Parse generated questions (max 5 per NFR-031)
  - Present to user via MCP tool response
  - Collect user answers (wait for user input)
  - Update spec.md with answers
  - Return list of ClarificationQuestion objects

- [ ] T073 [US7] Implement implementation plan generation via speckit.plan integration
  - Method: _generate_plan(feature_dir: str) -> ImplementationPlan
  - Run subprocess: .specify/commands/speckit.plan
  - Parse generated plan.md ‚Üí ImplementationPlan model
  - Extract: tech stack, libraries, structure, phases
  - Return plan for task breakdown phase

- [ ] T074 [US7] Implement task breakdown generation via speckit.tasks integration
  - Method: _generate_tasks(feature_dir: str) -> TaskBreakdown
  - Run subprocess: .specify/commands/speckit.tasks
  - Parse generated tasks.md ‚Üí TaskBreakdown model
  - Extract: task list, dependencies, parallel opportunities
  - Return tasks for consistency analysis

- [ ] T075 [US7] Implement consistency analysis via speckit.analyze integration
  - Method: _analyze_consistency(feature_dir: str) -> ConsistencyAnalysis
  - Run subprocess: .specify/commands/speckit.analyze
  - Parse analysis results ‚Üí ConsistencyAnalysis model
  - Check alignment: user request ‚Üî spec ‚Üî plan ‚Üî tasks
  - Return analysis with pass/fail status and issues

- [ ] T076 [US7] Implement text-based chatflow design summary generation
  - Method: _generate_design_summary(spec: ChatflowSpecification, plan: ImplementationPlan, tasks: TaskBreakdown) -> ChatflowDesignSummary
  - Create text summary: node layout, connections, data flow, configuration
  - Format: Markdown with sections (Overview, Nodes, Connections, Configuration, Expected Behavior)
  - Keep summary concise (<500 tokens) for user review
  - Return ChatflowDesignSummary for approval phase

- [ ] T077 [US7] Implement feedback loop (max 5 iterations per NFR-031)
  - Method: _handle_feedback(design_summary: ChatflowDesignSummary, user_feedback: str, iteration: int) -> FeedbackLoop
  - Parse user feedback for requested changes
  - If changes requested and iteration <5, loop back to clarification phase (T072)
  - If iteration ‚â•5 (max reached), abort workflow with status="max_iterations_exceeded"
  - If approved, proceed to chatflow creation with status="approved"
  - If rejected, abort workflow with status="rejected"
  - Return FeedbackLoop: status, iteration, next_action
  - Log message when max iterations: "Max feedback iterations (5) reached. Aborting workflow. Suggest simplifying requirements."

- [ ] T078 [US7] Implement chatflow creation from approved design
  - Method: _create_chatflow_from_design(design_summary: ChatflowDesignSummary) -> BuildFlowResponse
  - Extract nodes and connections from design
  - Call BuildFlowService.build_from_nodes(nodes, connections="auto")
  - Validate chatflow created successfully in Flowise
  - Return BuildFlowResponse with chatflow_id

- [ ] T079 [US7] Add error handling for spec-driven workflow failures
  - Catch subprocess errors (speckit commands fail)
  - Catch parsing errors (spec/plan/tasks malformed)
  - Catch timeout errors (user doesn't respond to clarification)
  - Return WorkflowResponse with status="error" and recovery suggestion
  - Log errors for debugging

- [ ] T080 [US7] Add spec_driven_workflow MCP tool in src/fluent_mind_mcp/server.py (optional - may use existing build_flow)
  - If separate tool: parameters include user_request (str)
  - If integrated: build_flow auto-detects complexity and triggers workflow
  - Return WorkflowResponse: status, chatflow_id (if created), design_summary, next_action
  - Handle async workflow (clarification questions require user input)

### Testing & Validation (T081-T082)

- [ ] T081 [US7] Create manual test checklist in tests/checklists/user_story_7_checklist.md
  - Scenario 1: Complex request ‚Üí spec-driven workflow triggered (not immediate build_flow)
  - Scenario 2: Spec created ‚Üí includes user intent, node rationale, connection logic, expected behavior
  - Scenario 3: Unclear aspects ‚Üí clarifying questions presented with options
  - Scenario 4: User answers ‚Üí spec updated, ambiguities resolved
  - Scenario 5: Plan created ‚Üí breaks down into phases (node selection, connections, config, validation)
  - Scenario 6: Tasks generated ‚Üí specific node configs, connection mappings, validation steps
  - Scenario 7: Consistency validated ‚Üí alignment between request, spec, plan, tasks
  - Scenario 8: Design presented ‚Üí node layout, connections, data flow, config summary
  - Scenario 9: User approves ‚Üí chatflow created via build_flow or Flowise API
  - Scenario 10: User provides feedback ‚Üí loop back to clarification, regenerate design
  - Scenario 11: Chatflow created ‚Üí chatflow_id and summary returned
  - Scenario 12: Creation fails ‚Üí issue reported, retry offered with adjusted parameters

- [ ] T082 [US7] Validate acceptance scenarios 1-12 pass via manual checklist
  - Execute complex workflow end-to-end manually
  - Test feedback loop (request changes, verify regeneration)
  - Document results in checklist
  - Mark as PASS or FAIL with notes

**Checkpoint**: User Story 7 complete - spec-driven workflow functional for complex chatflows

---

[‚Üê Back to Tasks Index](../tasks.md) | [Next: Circuit Breaker & Testing ‚Üí](05a-circuit.md)
